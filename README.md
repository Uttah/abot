# AnonBot - Telegram-бот для анонимных сообщений

Telegram-бот, позволяющий пользователям создавать уникальные ссылки для получения анонимных сообщений. Отправители могут писать текст, отправлять фото, видео, голосовые и другие типы медиа. Владелец ссылки может анонимно отвечать на полученные сообщения.

## Содержание

- [Возможности](#возможности)
- [Требования](#требования)
- [Переменные окружения](#переменные-окружения)
- [Установка и запуск](#установка-и-запуск)
  - [Локальный запуск](#локальный-запуск)
  - [Запуск через Docker](#запуск-через-docker)
- [Использование](#использование)
  - [Создание ссылки](#создание-ссылки)
  - [Отправка анонимного сообщения](#отправка-анонимного-сообщения)
  - [Ответ на сообщение](#ответ-на-сообщение)
- [Поддерживаемые типы контента](#поддерживаемые-типы-контента)
- [Структура проекта](#структура-проекта)
- [База данных](#база-данных)

## Возможности

- Создание уникальных ссылок для получения анонимных сообщений
- Отправка и получение текстовых сообщений
- Поддержка медиа: фото, видео, голосовые, видеокружки, стикеры, документы, аудио, GIF
- Анонимные ответы на полученные сообщения
- Сохранение истории сообщений в SQLite

## Требования

- Python 3.11+
- Docker (опционально)

## Переменные окружения

| Переменная | Обязательная | Описание |
|------------|--------------|----------|
| `BOT_TOKEN` | Да | Токен Telegram-бота, полученный от [@BotFather](https://t.me/BotFather) |

Переменные задаются в файле `.env` в корне проекта:

```env
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
```

## Установка и запуск

### Локальный запуск

1. Клонируйте репозиторий:
```bash
git clone https://github.com/Uttah/abot.git
cd abot
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` и добавьте токен бота:
```bash
echo "BOT_TOKEN=ваш_токен" > .env
```

4. Запустите бота:
```bash
python -m src
```

### Запуск через Docker

1. Соберите и запустите контейнер:
```bash
make run
```

Или вручную:
```bash
docker build -t anonbot:local .
docker run --rm -itd --name anonbot_local \
    -v $(pwd)/:/app \
    anonbot:local
```

2. Остановка и очистка:
```bash
make clean
```

## Использование

### Создание ссылки

1. Отправьте боту команду `/start`
2. Бот создаст уникальную ссылку вида `https://t.me/ИмяБота?start=КОД`
3. Поделитесь этой ссылкой с теми, от кого хотите получать анонимные сообщения

### Отправка анонимного сообщения

1. Перейдите по ссылке, полученной от владельца
2. Бот предложит написать анонимное сообщение
3. Отправьте текст или медиа (фото, видео, голосовое и т.д.)
4. Сообщение будет доставлено владельцу ссылки анонимно
5. Для выхода из режима отправки введите `/stop`

### Ответ на сообщение

1. При получении анонимного сообщения под ним появится кнопка "Ответить"
2. Нажмите на кнопку и введите текст ответа или отправьте медиа
3. Ответ будет доставлен отправителю анонимно

## Поддерживаемые типы контента

| Тип | Описание | Caption |
|-----|----------|---------|
| `text` | Текстовое сообщение | - |
| `photo` | Фотография | Да |
| `video` | Видео | Да |
| `animation` | GIF-анимация | Да |
| `voice` | Голосовое сообщение | Да |
| `video_note` | Видеокружок | Нет |
| `sticker` | Стикер | Нет |
| `document` | Документ/файл | Да |
| `audio` | Аудиофайл | Да |

## Структура проекта

```
abot/
├── src/
│   ├── __init__.py
│   ├── __main__.py          # Точка входа
│   ├── bot.py               # Инициализация бота и диспетчера
│   ├── config.py            # Загрузка конфигурации из .env
│   ├── database.py          # Схема БД и миграции
│   ├── callbacks.py         # Callback-данные для inline-кнопок
│   ├── keyboards.py         # Inline-клавиатуры
│   ├── media.py             # Утилиты для работы с медиа
│   ├── states.py            # FSM-состояния
│   └── handlers/
│       ├── start.py         # Обработчик /start
│       ├── stop.py          # Обработчик /stop
│       ├── anon_message.py  # Отправка анонимных сообщений
│       ├── reply_click.py   # Нажатие кнопки "Ответить"
│       ├── owner_reply.py   # Отправка ответа
│       └── debug.py         # Отладочный хендлер
├── db/                      # Директория для SQLite базы (создаётся автоматически)
├── Dockerfile
├── Makefile
├── requirements.txt
└── README.md
```

## База данных

Используется SQLite. База создаётся автоматически при первом запуске в `/app/db/anonbot.db`.

### Таблицы

**users** — пользователи бота
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Первичный ключ |
| `tg_user_id` | INTEGER | Telegram ID пользователя |

**links** — ссылки для анонимных сообщений
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Первичный ключ |
| `code` | TEXT | Уникальный код ссылки |
| `owner_id` | INTEGER | FK на users.id |

**messages** — сообщения
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Первичный ключ |
| `link_id` | INTEGER | FK на links.id |
| `sender_user_id` | INTEGER | FK на users.id (NULL для ответов владельца) |
| `text` | TEXT | Текст сообщения или caption |
| `media_type` | TEXT | Тип медиа (photo, video, и т.д.) |
| `media_file_id` | TEXT | Telegram file_id для медиа |
| `created_at` | DATETIME | Время создания |
| `reply_to_id` | INTEGER | ID сообщения, на которое это ответ |
